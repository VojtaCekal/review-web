<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recenze produktu</title>
  <link rel="stylesheet" href="styl.css">
<style>
  /* Jednoduch√© CSS pro lep≈°√≠ p≈ôehled */
  .container { max-width: 700px; margin: auto; padding: 15px; }
  #reviews .review { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  #adminPanel { border: 2px solid #333; padding-left: 10px; margin-bottom: 15px; }
  #loginBox { position: fixed; top: 10px; right: 10px; z-index: 100; }
  
  /* Responsive design */
  @media (max-width: 768px) {
    input, textarea, button, select { width: 100% !important; }
    textarea { padding: 10px; }
    #adminPanel { padding-left: 15px; }
  }
</style>
</head>
<body>

<!-- Admin panel -->
<div id="adminPanel" style="display:none;">
  <h3>Admin panel</h3>
  <button onclick="logout()">Odhl√°sit</button>
  <p>Celkem recenz√≠: <span id="adminCount">0</span></p>
</div>

<!-- Login box -->
<div id="loginBox">
  <button onclick="login()">Admin login</button>
</div>

<!-- Odpovƒõƒè na recenze pro admina -->
<div id="responseModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:10px; width:90%; max-width:500px;">
    <h3>Odpovƒõƒè na recenzi</h3>
    <textarea id="responseText" placeholder="Napi≈°te odpovƒõƒè..." style="width:80%; height:100px;"></textarea>
    <div style="margin-top:10px;">
      <button onclick="submitResponse()" style="width:48%; margin-right:2%;">Odeslat</button>
      <button onclick="closeResponseModal()" style="width:48%; background:#999;">Zru≈°it</button>
    </div>
  </div>
</div>

<!-- Formul√°≈ô pro p≈ôid√°n√≠ recenze -->
<div class="container">
  <h1>Recenze ...</h1>
  <input type="text" id="name" placeholder="Va≈°e jm√©no">
  <input type="email" id="email" placeholder="Va≈°e emailov√° adresa">
  <textarea id="text" placeholder="Napi≈°te recenzi..."></textarea>
  <select id="rating">
    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
    <option value="3">‚≠ê‚≠ê‚≠ê</option>
    <option value="2">‚≠ê‚≠ê</option>
    <option value="1">‚≠ê</option>
  </select>
  <button onclick="addReview()">P≈ôidat recenzi</button>
  <h5>V≈°echna pole kromƒõ emailu jsou povinn√©</h5>
</div>

<!-- Statistika a recenze -->
<footer>
  <div class="recenze_ramec">
    <div id="stats">
      <h2>‚≠ê Hodnocen√≠: <span id="avg">0</span> / 5</h2>
      <p>Poƒçet recenz√≠: <span id="count">0</span></p>
    </div>
    <h2>Recenze</h2>
    <div id="reviews"></div>
  </div>
</footer>

<script type="module">
let renderId = 0;
let currentResponseId = null; // ID recenze, na kterou odpov√≠d√°me
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBGcNTTQ-hlpbab3lwiuzgB_BtR8RWq3Ow",
  authDomain: "recenze-86af3.firebaseapp.com",
  projectId: "recenze-86af3",
  storageBucket: "recenze-86af3.firebasestorage.app",
  messagingSenderId: "702942416836",
  appId: "1:702942416836:web:5a0208bcff52475ef3de91"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let isAdmin = false;
const reviewsDiv = document.getElementById("reviews");

// ----------------- Auth State -----------------
onAuthStateChanged(auth, user => {
  isAdmin = user && user.email === "cekal.vojta0411@gmail.com";

  document.getElementById("loginBox").style.display = isAdmin ? "none" : "block";
  document.getElementById("adminPanel").style.display = isAdmin ? "block" : "none";

  // v≈ædy znovu naƒç√≠st recenze ƒçistƒõ
  renderReviews();
});

// ----------------- Render Reviews -----------------
async function renderReviews() {
  const thisRun = ++renderId;
  reviewsDiv.innerHTML = ""; // vyƒçistit div p≈ôed vykreslen√≠m
  let total = 0;
  let count = 0;

  let q;
  if (isAdmin) {
    q = query(collection(db, "reviews"), orderBy("time", "desc"));
  } else {
    q = query(collection(db, "reviews"), where("approved", "==", true), orderBy("time", "desc"));
  }

  const snapshot = await getDocs(q);

  if (thisRun !== renderId) return; // discard stale render results

  snapshot.forEach(docSnap => {
    const r = docSnap.data();

    if (!isAdmin && !r.approved) return;

    const div = document.createElement("div");
    div.classList.add("review");
    
    // Form√°tov√°n√≠ ƒçasu
    const reviewDate = new Date(r.time);
    const formattedTime = reviewDate.toLocaleDateString("cs-CZ");
    
    const nameEl = document.createElement("strong");
    nameEl.textContent = r.name;
    div.appendChild(nameEl);
    
    const emailEl = document.createElement("span");
    emailEl.textContent = " (" + (r.email || "email nespecifikov√°n") + ")";
    div.appendChild(emailEl);
    
    div.appendChild(document.createElement("br"));
    
    const dateEl = document.createElement("small");
    dateEl.style.color = "#666";
    dateEl.textContent = "P≈ôid√°no: " + formattedTime;
    div.appendChild(dateEl);
    
    div.appendChild(document.createElement("br"));
    
    const starsEl = document.createElement("span");
    starsEl.classList.add("stars");
    starsEl.textContent = "‚≠ê".repeat(r.rating);
    div.appendChild(starsEl);
    
    const textEl = document.createElement("p");
    textEl.textContent = r.text;
    div.appendChild(textEl);
    
    if (isAdmin && !r.approved) {
      const approveBtn = document.createElement("button");
      approveBtn.textContent = "‚úÖ Schv√°lit";
      approveBtn.onclick = () => approveReview(docSnap.id);
      div.appendChild(approveBtn);
    }
    
    if (isAdmin) {
      const replyBtn = document.createElement("button");
      replyBtn.textContent = "üí¨ Odpovƒõdƒõt";
      replyBtn.onclick = () => openResponseModal(docSnap.id);
      div.appendChild(replyBtn);
      
      const delBtn = document.createElement("button");
      delBtn.textContent = "‚ùå Smazat";
      delBtn.onclick = () => deleteReview(docSnap.id);
      div.appendChild(delBtn);
    }
    
    if (r.adminResponse) {
      const responseDiv = document.createElement("div");
      responseDiv.style.background = "#f0f0f0";
      responseDiv.style.padding = "10px";
      responseDiv.style.marginTop = "10px";
      responseDiv.style.borderLeft = "3px solid #ff9800";
      
      const responseTitle = document.createElement("strong");
      responseTitle.textContent = "Majitel odpovƒõdƒõl:";
      responseDiv.appendChild(responseTitle);
      
      const responseText = document.createElement("p");
      responseText.textContent = r.adminResponse;
      responseDiv.appendChild(responseText);
      
      div.appendChild(responseDiv);
    }

    reviewsDiv.appendChild(div);

    total += Number(r.rating);
    count++;
  });

  document.getElementById("avg").textContent = count ? (total / count).toFixed(1) : "0.0";
  document.getElementById("count").textContent = count;
  document.getElementById("adminCount").textContent = count;
}

// ----------------- Add Review -----------------
window.addReview = async function() {
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  const text = document.getElementById("text").value;
  const rating = document.getElementById("rating").value;

  if (!name || !text) return alert("Vypl≈à jm√©no i recenzi!");
  if (text.length < 10) return alert("Recenze je moc kr√°tk√°.");

  await addDoc(collection(db, "reviews"), {
    name,
    email,
    text,
    rating,
    approved: isAdmin, // admin schv√°l√≠ hned
    time: Date.now()
  });

  if (!isAdmin) alert("Dƒõkujeme za recenzi! ƒåek√° na schv√°len√≠.");

  // Vymazat text v pol√≠ch
  document.getElementById("name").value = "";
  document.getElementById("email").value = "";
  document.getElementById("text").value = "";
  document.getElementById("rating").value = "5";

  renderReviews(); // v≈ædy vykreslit ƒçerstv√© recenze
};

// ----------------- Delete Review -----------------
window.deleteReview = async function(id) {
  if (!isAdmin) return alert("Nem√°≈° opr√°vnƒõn√≠!");
  await deleteDoc(doc(db, "reviews", id));
  renderReviews();
};

// ----------------- Approve Review -----------------
window.approveReview = async function(id) {
  if (!isAdmin) return alert("Nem√°≈° opr√°vnƒõn√≠!");
  await updateDoc(doc(db, "reviews", id), { approved: true });
  renderReviews();
};

// ----------------- Login -----------------
window.login = async function() {
  const email = prompt("Email:");
  const pass = prompt("Heslo:");
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    alert("P≈ôihl√°≈°en!");
  } catch {
    alert("≈†patn√© √∫daje");
  }
};

// ----------------- Logout -----------------
window.logout = async function() {
  await signOut(auth);
  isAdmin = false;
  alert("Odhl√°≈°en!");
  renderReviews();
};

// ----------------- Response Modal -----------------
window.openResponseModal = function(id) {
  if (!isAdmin) return alert("Nem√°≈° opr√°vnƒõn√≠!");
  currentResponseId = id;
  document.getElementById("responseText").value = "";
  document.getElementById("responseModal").style.display = "block";
};

window.closeResponseModal = function() {
  document.getElementById("responseModal").style.display = "none";
  currentResponseId = null;
};

// ----------------- Submit Response -----------------
window.submitResponse = async function() {
  if (!currentResponseId) return;
  const responseText = document.getElementById("responseText").value.trim();
  
  if (!responseText) {
    alert("Napi≈°te odpovƒõƒè!");
    return;
  }
  
  if (responseText.length < 5) {
    alert("Odpovƒõƒè je moc kr√°tk√°.");
    return;
  }

  await updateDoc(doc(db, "reviews", currentResponseId), {
    adminResponse: responseText
  });

  closeResponseModal();
  renderReviews();
};

// Zav≈ô√≠t modal p≈ôi kliknut√≠ mimo nƒõj
window.onclick = function(event) {
  const modal = document.getElementById("responseModal");
  if (event.target === modal) {
    modal.style.display = "none";
    currentResponseId = null;
  }
};
</script>

</body>
</html>

